# Proxy cache configuration
proxy_cache_path /var/cache/nginx/DTED.org
                 keys_zone=DTEDCache:50m
                 levels=1:2
                 inactive=2w
                 max_size=1g;

# CORS configuration
map $http_origin $allow_origin {
    https://DTED.org $http_origin;
    default "";
}

server {
    root /var/www/html/DTED.org/web;
    server_name DTED.org;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/dted.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dted.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Nginx status
    location /nginx_status {
        stub_status;
        allow 127.0.0.1;
        deny all;
    }
    
    location / {
        root /var/www/html/DTED.org/web/html;
    }

    location /elevation/ {
        root /var/www/html/DTED.org/data/elevation/;
        autoindex on;
    }
}

server {
    if ($host = DTED.org) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    server_name DTED.org;

    # Nginx status
    location /nginx_status {
        stub_status;
        allow 127.0.0.1;
        deny all;
    }
}

server {
    root /var/www/html/dted.org/data/CA;
    server_name CA.DTED.org;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/ca.dted.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ca.dted.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        root /var/www/html/DTED.org/data/CA;
    }
}

server {
    if ($host = CA.DTED.org) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    server_name CA.DTED.org;
}